<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Drive File Renamer</title>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Reset and base styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Google Sans', -apple-system, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.4;
      font-size: 13px;
    }

    .container {
      padding: 16px;
      max-width: 100%;
    }

    .header {
      background: linear-gradient(135deg, #1a73e8, #1557b0);
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .section {
      background: white;
      border: 1px solid #dadce0;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .section-header {
      background: #f8f9fa;
      padding: 12px 16px;
      border-bottom: 1px solid #dadce0;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-content {
      padding: 16px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 12px;
      color: #5f6368;
    }

    .form-select, .form-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #dadce0;
  border-radius: 4px;
  font-size: 13px;
  background: white;
}

.form-select:focus, .form-input:focus {
  outline: none; /* Add or ensure this is present */
  border-color: #1a73e8;
  box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
}

/* Also, if you added the specific rule for .status-dropdown:focus previously, keep it.
   It helps to be explicit. */
.status-dropdown:focus {
  outline: none; /* Remove default outline */
  border-color: #1a73e8; /* Keep your blue border color */
  box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1); /* Keep your subtle blue shadow */
}
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1557b0;
    }

    .btn-success {
      background: #34a853;
      color: white;
    }

    .btn-warning {
      background: #fbbc04;
      color: #202124;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
    }

    .status-success {
      background: rgba(52, 168, 83, 0.1);
      color: #34a853;
      border: 1px solid rgba(52, 168, 83, 0.3);
    }

    .status-error {
      background: rgba(234, 67, 53, 0.1);
      color: #ea4335;
      border: 1px solid rgba(234, 67, 53, 0.3);
    }

    .status-info {
      background: rgba(26, 115, 232, 0.1);
      color: #1a73e8;
      border: 1px solid rgba(26, 115, 232, 0.3);
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat {
      text-align: center;
      flex: 1;
    }

    .stat-number {
      font-size: 20px;
      font-weight: 600;
      color: #1a73e8;
    }

    .stat-label {
      font-size: 11px;
      color: #5f6368;
    }

    .file-item {
      background: white;
      border: 1px solid #dadce0;
      border-radius: 6px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .file-item.processed {
      background: rgba(52, 168, 83, 0.05);
      border-color: rgba(52, 168, 83, 0.3);
    }

    .file-header {
      padding: 12px;
      background: #f8f9fa;
      border-bottom: 1px solid #dadce0;
    }

    .file-name {
      font-weight: 500;
      font-size: 13px;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .file-meta {
      font-size: 11px;
      color: #5f6368;
    }

    .file-content {
      padding: 12px;
    }

    .reason-box {
      background: rgba(251, 188, 4, 0.1);
      border-left: 3px solid #fbbc04;
      padding: 8px 12px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .ai-results {
      background: #f8f9fa;
      border-radius: 4px;
      padding: 12px;
      margin: 12px 0;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .data-label {
      font-size: 11px;
      color: #5f6368;
      font-weight: 500;
    }

    .data-value {
      font-size: 12px;
      color: #202124;
      font-weight: 500;
    }

    /* Styles for the editable filename input */
    .filename-edit-group {
      margin: 8px 0 12px 0;
    }
    
    .filename-edit-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 12px;
      color: #5f6368;
    }

  .filename-edit-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #dadce0;
  border-radius: 4px;
  font-family: monospace; /* Monospaced font for filenames */
  font-size: 11px;
  word-break: break-all;
  background: white;

  /* Add or modify these properties for height */
  height: auto; /* Allow height to adjust to content */
  min-height: 40px; /* Set a minimum height for visibility */
  resize: vertical; /* Allow vertical resizing by the user */
  overflow-y: auto; /* Add scrollbar if content exceeds height */
  white-space: pre-wrap; /* Ensures text wraps and maintains spaces/line breaks */
}
    
    .filename-edit-input:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .action-row .btn {
      flex: 1; /* Make buttons take equal width */
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(26, 115, 232, 0.2);
      border-top: 2px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: #5f6368;
    }

    .empty-state i {
      font-size: 32px;
      margin-bottom: 12px;
      color: #dadce0;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      color: #5f6368;
      font-style: italic;
    }

    .confidence {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .confidence-bar {
      flex: 1;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #ea4335 0%, #fbbc04 50%, #34a853 100%);
      transition: width 0.3s;
    }
    .invoice-status-group {
  margin: 12px 0;
  padding: 12px;
  background: rgba(26, 115, 232, 0.05);
  border-radius: 6px;
  border: 1px solid rgba(26, 115, 232, 0.2);
}

.invoice-status-label {
  display: block;
  font-weight: 500;
  margin-bottom: 8px;
  font-size: 12px;
  color: #1a73e8;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
}

.status-inflow {
  background: rgba(52, 168, 83, 0.1);
  color: #34a853;
  border: 1px solid rgba(52, 168, 83, 0.3);
}

.status-outflow {
  background: rgba(234, 67, 53, 0.1);
  color: #ea4335;
  border: 1px solid rgba(234, 67, 53, 0.3);
}

.status-dropdown:focus {
  outline: none; /* Remove default outline */
  border-color: #1a73e8; /* Keep your blue border color */
  box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1); /* Keep your subtle blue shadow */
}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-file-signature"></i> Drive File Renamer</h1>
      <p>AI-powered document renaming for Drive</p>
    </header>

    <div class="section">
      <div class="section-header">
        <i class="fas fa-table"></i>
        Select Spreadsheet
      </div>
      <div class="section-content">
        <div class="form-group">
          <select id="sheetSelect" class="form-select">
            <option value="">Loading sheets...</option>
          </select>
        </div>
        <button id="loadFilesBtn" class="btn btn-primary">
          <i class="fas fa-search"></i>
          Analyze Files
        </button>
        <div id="loadStatus"></div>
      </div>
    </div>

    <div class="section" id="processingSection" style="display: none;">
      <div class="section-header">
        <i class="fas fa-cogs"></i>
        Processing Files
      </div>
       <div id="statsBar" class="stats">
          <div class="stat">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="processedCount">0</div>
            <div class="stat-label">Processed</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="renamedCount">0</div>
            <div class="stat-label">Renamed</div>
          </div>
        </div>
</div>
        </div>
        
        <div id="filesContainer">
          <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>No files to process</h3>
            <p>Select a spreadsheet and analyze files</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const elements = {
      sheetSelect: document.getElementById('sheetSelect'),
      loadFilesBtn: document.getElementById('loadFilesBtn'),
      loadStatus: document.getElementById('loadStatus'),
      processingSection: document.getElementById('processingSection'),
      filesContainer: document.getElementById('filesContainer'),
      totalCount: document.getElementById('totalCount'),
      processedCount: document.getElementById('processedCount'),
      renamedCount: document.getElementById('renamedCount')
    };

    let currentSheet = '';
    let files = []; // Stores the file data loaded from the sheet
    let stats = { total: 0, processed: 0, renamed: 0 };

    function showStatus(message, type = 'info', container = elements.loadStatus) {
      const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
      container.innerHTML = `
        <div class="status status-${type}">
          <i class="fas fa-${icons[type]}"></i>
          ${message}
        </div>
      `;
    }

 function updateStats() {
      elements.totalCount.textContent = stats.total;
      elements.processedCount.textContent = stats.processed;
      elements.renamedCount.textContent = stats.renamed;
    }

    // Load spreadsheets
    google.script.run
      .withSuccessHandler(sheetNames => {
        elements.sheetSelect.innerHTML = '<option value="">-- Select Spreadsheet --</option>';
        if (sheetNames.length > 0) {
            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = option.textContent = name;
                elements.sheetSelect.appendChild(option);
            });
            showStatus('Spreadsheets loaded successfully.', 'success');
        } else {
            showStatus('No spreadsheets found or accessible.', 'info');
        }
      })
      .withFailureHandler(error => {
        elements.sheetSelect.innerHTML = '<option value="">Error loading sheets</option>';
        showStatus('Failed to load spreadsheets: ' + error.message, 'error');
      })
      .getSubsheetNamesGAS();

    // Load files for processing
    elements.loadFilesBtn.addEventListener('click', () => {
      currentSheet = elements.sheetSelect.value;
      if (!currentSheet) {
        showStatus('Please select a spreadsheet.', 'error');
        return;
      }

      elements.loadFilesBtn.disabled = true;
      elements.loadFilesBtn.innerHTML = '<div class="spinner"></div> Analyzing...';
      elements.filesContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing files...</div>';
      elements.processingSection.style.display = 'block'; // Show processing section immediately

      google.script.run
        .withSuccessHandler(fileList => {
          elements.loadFilesBtn.disabled = false;
          elements.loadFilesBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Files';
          
          files = fileList;
stats = { total: fileList.length, processed: 0, renamed: 0 };
updateStats();
          
          if (fileList.length === 0) {
            elements.filesContainer.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <h3>All files properly named</h3>
                <p>No files need renaming in the selected sheet.</p>
              </div>
            `;
            showStatus('No files need processing.', 'info');
          } else {
            displayFiles(fileList);
          showStatus(`Found ${fileList.length} files to process.`, 'success'); 
          }
        })
        .withFailureHandler(error => {
          elements.loadFilesBtn.disabled = false;
          elements.loadFilesBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Files';
          showStatus('Error analyzing files: ' + error.message, 'error');
          elements.filesContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading files</h3>
              <p>${error.message}</p>
            </div>
          `;
        })
        .loadFilesForProcessingGAS(currentSheet);
    });

    function displayFiles(fileList) {
      elements.filesContainer.innerHTML = ''; // Clear previous files

      fileList.forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';
fileDiv.id = `file-${index}`;
        
        fileDiv.innerHTML = `
          <div class="file-header">
            <div class="file-name">${file.originalName}</div>
            <div class="file-meta">
  Row: ${file.sheetRow} â€¢ 
  MIME: ${file.mimeType.split('/')[1].toUpperCase()}
</div>
          </div>
          <div class="file-content" id="content-${index}">
            <div class="reason-box">
  <strong>Needs Processing:</strong><br>
  ${file.validationResult.reason}. 
  Details: ${file.validationResult.details}
</div>
            <div class="action-row" style="margin-bottom: 12px;">
                <button onclick="window.open('${file.fileUrl}', '_blank')" class="btn btn-warning btn-sm">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button onclick="processFile(${index})" class="btn btn-primary btn-sm" id="processBtn-${index}">
                    <i class="fas fa-robot"></i> Process with AI
                </button>
            </div>
            <div id="status-${index}"></div>
          </div>
        `;
        
        elements.filesContainer.appendChild(fileDiv);
      });
    }
     function generateInvoiceStatusUI(invoiceStatus, index) {
      // Always return the select dropdown
      // Set the 'selected' attribute based on the AI's detected status
      const inflowSelected = invoiceStatus === 'inflow' ? 'selected' : '';
      const outflowSelected = invoiceStatus === 'outflow' ? 'selected' : '';

      return `<select id="invoiceStatusSelect-${index}" class="status-dropdown">
                <option value="" ${(!inflowSelected && !outflowSelected) ? 'selected' : ''}>-- Select Status --</option>
                <option value="inflow" ${inflowSelected}>Inflow</option>
                <option value="outflow" ${outflowSelected}>Outflow</option>
              </select>`;
    }
function getInvoiceStatus(index) {
  const selectElement = document.getElementById(`invoiceStatusSelect-${index}`);
  if (selectElement) {
    return selectElement.value;
  }
  
  // Check if it's a fixed status badge
  const container = document.getElementById(`invoiceStatusContainer-${index}`);
  const badge = container.querySelector('.status-badge');
  if (badge) {
    return badge.classList.contains('status-inflow') ? 'inflow' : 'outflow';
  }
  
  return '';
}


    async function processFile(index) {
      const file = files[index];
      const statusDiv = document.getElementById(`status-${index}`);
      const processBtn = document.getElementById(`processBtn-${index}`);
      const contentDiv = document.getElementById(`content-${index}`);
      
      // Disable both buttons in the action-row during processing
      const actionRow = contentDiv.querySelector('.action-row');
      Array.from(actionRow.children).forEach(btn => btn.disabled = true);

      processBtn.innerHTML = '<div class="spinner"></div> Processing...';
      showStatus('Processing with AI...', 'info', statusDiv);

      try {
        const aiData = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .processFileWithAIGAS(file.fileId, file.originalName, file.mimeType, file.fileUrl);
        });

        if (aiData.error) {
          showStatus(`AI Error: ${aiData.error}`, 'error', statusDiv);
          // Re-enable original buttons if processing failed
          Array.from(actionRow.children).forEach(btn => btn.disabled = false);
          processBtn.innerHTML = '<i class="fas fa-robot"></i> Retry';
          return;
        }

        const newFilename = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .generateNewFilename(aiData, file.originalName);
        });

        showStatus('AI extraction completed.', 'success', statusDiv);
        
        // Calculate confidence percentage if it's a string like "High (Gemini 2.0 Flash)"
        let confidenceDisplay = aiData.confidence || "N/A";
        let confidenceWidth = 0;
        if (typeof confidenceDisplay === 'string') {
            if (confidenceDisplay.toLowerCase().includes('high')) confidenceWidth = 100;
            else if (confidenceDisplay.toLowerCase().includes('medium')) confidenceWidth = 60;
            else if (confidenceDisplay.toLowerCase().includes('low')) confidenceWidth = 30;
            // Remove text after parenthesis if present
            confidenceDisplay = confidenceDisplay.split('(')[0].trim();
        } else if (typeof confidenceDisplay === 'number') {
             confidenceWidth = confidenceDisplay; // If it's already a number
             confidenceDisplay = `${confidenceDisplay}%`;
        }
        

        // Remove the original action row and replace content with AI results
        actionRow.remove(); 
        
contentDiv.innerHTML += `
  <div class="ai-results">
    <div class="confidence">
      <span class="data-label">AI Confidence:</span>
      <div class="confidence-bar">
        <div class="confidence-fill" style="width: ${confidenceWidth}%;"></div>
      </div>
      <span class="data-value">${confidenceDisplay}</span>
    </div>
    
    <div class="data-row">
      <span class="data-label">DATE:</span>
      <span class="data-value">${aiData.date || 'N/A'}</span>
    </div>
    <div class="data-row">
      <span class="data-label">VENDOR:</span>
      <span class="data-value">${aiData.vendorName || 'N/A'}</span>
    </div>
    <div class="data-row">
      <span class="data-label">INVOICE:</span>
      <span class="data-value">${aiData.invoiceNumber || 'N/A'}</span>
    </div>
    <div class="data-row">
      <span class="data-label">AMOUNT:</span>
      <span class="data-value">${aiData.amount || 'N/A'}</span>
    </div>
    
    <div class="invoice-status-group">
      <label class="invoice-status-label">Invoice Status:</label>
      <div id="invoiceStatusContainer-${index}">
        ${generateInvoiceStatusUI(aiData.invoiceStatus, index)}
      </div>

      <div class="invoices-row">
      <span class="data-label">NO_OF_INVOICES</span>
      <span class="data-value">${aiData.numberofinvoices || 'N/A'}</span>
    </div>
    </div>
    
    <div class="form-group filename-edit-group">
      <label for="newFilenameInput-${index}" class="filename-edit-label">Suggested New Filename:</label>
      <input type="text" id="newFilenameInput-${index}" class="filename-edit-input"
       value="${newFilename.replace(/"/g, '&quot;')}"
       placeholder="DATE_VENDOR_INVOICE_AMOUNT" />
    </div>
    
    <div class="action-row">
      <button onclick="window.open('${file.fileUrl}', '_blank')" class="btn btn-warning">
        <i class="fas fa-eye"></i> Preview
      </button>
      <button onclick="renameFile(${index})"
              class="btn btn-success" id="renameBtn-${index}">
        <i class="fas fa-file-signature"></i> Rename File
      </button>
    </div>
    <div id="renameStatus-${index}"></div>
  </div>
`;
        stats.processed++;
        updateStats();

      } catch (error) {
        showStatus(`Processing failed: ${error.message}`, 'error', statusDiv);
        // Re-add and re-enable original buttons if processing failed
        contentDiv.innerHTML = `
            <div class="reason-box">
              <strong>Needs Processing:</strong><br>
              ${file.validationResult.reason}. 
              Details: ${file.validationResult.details}
            </div>
            <div class="action-row" style="margin-bottom: 12px;">
                <button onclick="window.open('${file.fileUrl}', '_blank')" class="btn btn-warning btn-sm">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button onclick="processFile(${index})" class="btn btn-primary btn-sm" id="processBtn-${index}">
                    <i class="fas fa-robot"></i> Retry
                </button>
            </div>
            <div id="status-${index}"></div>
        `;
      }
    }

    async function renameFile(index) {
      const file = files[index];
      const newNameInput = document.getElementById(`newFilenameInput-${index}`);
      const newName = newNameInput.value; // Get the value from the input field
      
      const renameBtn = document.getElementById(`renameBtn-${index}`);
      const previewBtn = renameBtn.previousElementSibling; // Get the preview button

      const statusDiv = document.getElementById(`renameStatus-${index}`);
      const fileDiv = document.getElementById(`file-${index}`);
      
      renameBtn.disabled = true;
      previewBtn.disabled = true; // Disable preview during rename
      renameBtn.innerHTML = '<div class="spinner"></div> Renaming...';
      showStatus('Renaming file...', 'info', statusDiv);
      const invoiceStatus = getInvoiceStatus(index);
if (!invoiceStatus) {
  showStatus('Please select invoice status before renaming.', 'error', statusDiv);
  renameBtn.disabled = false;
  previewBtn.disabled = false;
  renameBtn.innerHTML = '<i class="fas fa-file-signature"></i> Rename File';
  return;
}

      try {
        const result = await new Promise((resolve, reject) => {
  const invoiceStatus = getInvoiceStatus(index);
  google.script.run
    .withSuccessHandler(resolve)
    .withFailureHandler(reject)
    .renameFileAndUpdateSheetGAS(file.fileId, newName, currentSheet, file.sheetRow, 1, invoiceStatus);
});

        if (result.success) {
          showStatus(`File renamed successfully!`, 'success', statusDiv);
          fileDiv.classList.add('processed'); // Highlight as processed
          fileDiv.querySelector('.file-name').innerHTML = `<i class="fas fa-check-circle" style="color: #34a853;"></i> ${newName}`;
          renameBtn.innerHTML = '<i class="fas fa-check"></i> Renamed';
          renameBtn.disabled = true;
          newNameInput.disabled = true; // Disable editing after rename
          previewBtn.disabled = true; // Keep preview disabled as file is processed
          
          stats.renamed++;
          updateStats();
        } else {
          showStatus(`Rename failed: ${result.message}`, 'error', statusDiv);
          renameBtn.disabled = false;
          previewBtn.disabled = false; // Re-enable preview if rename failed
          renameBtn.innerHTML = '<i class="fas fa-file-signature"></i> Retry';
        }
      } catch (error) {
        showStatus(`Rename error: ${error.message}`, 'error', statusDiv);
        renameBtn.disabled = false;
        previewBtn.disabled = false; // Re-enable preview if rename failed
        renameBtn.innerHTML = '<i class="fas fa-file-signature"></i> Retry';
      }
    }
  </script>
</body>
</html>